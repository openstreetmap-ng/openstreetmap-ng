name: Setup environment
description: Install Nix and cache dependencies

runs:
  using: "composite"
  steps:
    - uses: nixbuild/nix-quick-install-action@v34

    - name: Derive cache key
      shell: bash
      run: |
        nixpkgs_hash=$(grep -Eom1 'archive/[0-9a-f]{40}\.tar\.gz' shell.nix | cut -d'/' -f2 | cut -d'.' -f1)
        echo "NIXPKGS_HASH=$nixpkgs_hash" >> $GITHUB_ENV
        echo "CACHE_KEY=${{ runner.os }}-$nixpkgs_hash" >> $GITHUB_ENV

    - uses: nix-community/cache-nix-action@v6
      with:
        primary-key: nix-${{ env.CACHE_KEY }}

    - name: Setup NIX_PATH
      shell: bash
      run: |
        path=$(nix eval --impure --expr "(import (fetchTarball \"https://github.com/NixOS/nixpkgs/archive/${{ env.NIXPKGS_HASH }}.tar.gz\") {}).path")
        echo "NIX_PATH=nixpkgs=$path" >> $GITHUB_ENV

    - name: Cache files and packages
      uses: actions/cache@v4
      with:
        key: pkg-${{ env.CACHE_KEY }}-${{ hashFiles('uv.lock', 'bun.lock', 'speedup/Cargo.lock', 'rust-toolchain.toml') }}
        path: |
          ~/.bun/install/cache
          ~/.cache/uv
          ~/Library/Caches/uv
          ~/.cargo/git
          ~/.cargo/registry
          ~/.rustup/downloads
          ~/.rustup/toolchains
          .venv
          node_modules
          speedup/target
          app/static/img/browser
          app/static/img/controls/_generated
          app/static/img/element/_generated
          config/locale/gnu
          config/locale/i18next
          config/locale/postprocess
