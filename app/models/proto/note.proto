syntax = "proto3";

import "app/models/proto/shared.proto";
import "buf/validate/validate.proto";

enum NoteStatus {
  open = 0;
  closed = 1;
  hidden = 2;
}

service NoteService {
  rpc GetNote(GetNoteRequest) returns (GetNoteResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  rpc GetNoteComments(GetNoteCommentsRequest) returns (GetNoteCommentsResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  rpc AddNoteComment(AddNoteCommentRequest) returns (AddNoteCommentResponse) {}

  rpc SetNoteSubscription(SetNoteSubscriptionRequest) returns (SetNoteSubscriptionResponse) {
    option idempotency_level = IDEMPOTENT;
  }
}

message GetNoteRequest {
  uint64 id = 1 [(buf.validate.field).uint64.gt = 0];
}

message GetNoteResponse {
  NoteData note = 1 [(buf.validate.field).required = true];
}

message GetNoteCommentsRequest {
  StandardPaginationState state = 1;
  uint64 id = 2 [(buf.validate.field).uint64.gt = 0];
}

message GetNoteCommentsResponse {
  message Comment {
    enum Event {
      opened = 0;
      closed = 1;
      reopened = 2;
      commented = 3;
      hidden = 4;
    }

    optional User user = 1;
    Event event = 2;
    uint64 created_at = 3;
    string body_rich = 4;
  }

  StandardPaginationState state = 1 [(buf.validate.field).required = true];
  repeated Comment comments = 2;
}

message AddNoteCommentRequest {
  option (buf.validate.message).cel_expression = "this.event != 0";

  uint64 id = 1 [(buf.validate.field).uint64.gt = 0];
  GetNoteCommentsResponse.Comment.Event event = 2 [(buf.validate.field).enum.defined_only = true];
  string text = 3 [(buf.validate.field).string.max_len = 2000];
}

message AddNoteCommentResponse {
  NoteData note = 1 [(buf.validate.field).required = true];
  GetNoteCommentsResponse comments = 2 [(buf.validate.field).required = true];
}

message SetNoteSubscriptionRequest {
  uint64 id = 1 [(buf.validate.field).uint64.gt = 0];
  bool is_subscribed = 2;
}

message SetNoteSubscriptionResponse {
  bool is_subscribed = 1;
}

message NoteData {
  message Header {
    optional User user = 1;
    uint64 created_at = 2;
    string body_rich = 3;
  }

  uint64 id = 1;
  LonLat location = 2 [(buf.validate.field).required = true];
  NoteStatus status = 3;
  Header header = 4 [(buf.validate.field).required = true];
  bool is_subscribed = 5;
  optional uint32 disappear_days = 6;
}

message RenderNotesData {
  message Note {
    uint64 id = 1;
    LonLat location = 2 [(buf.validate.field).required = true];
    string text = 3;
    NoteStatus status = 4;
  }

  repeated Note notes = 1;
}
