syntax = "proto3";

import "buf/validate/validate.proto";

// =============================================
// Common
// =============================================

message IdResponse {
  uint64 id = 1;
}

message User {
  uint64 id = 1;
  string display_name = 2;
  string avatar_url = 3;
}

message LonLat {
  float lon = 1 [(buf.validate.field).float = {
    gte: -180
    lte: 180
  }];
  float lat = 2 [(buf.validate.field).float = {
    gte: -90
    lte: 90
  }];
}

message LonLatZoom {
  float lon = 1 [(buf.validate.field).float = {
    gte: -180
    lte: 180
  }];
  float lat = 2 [(buf.validate.field).float = {
    gte: -90
    lte: 90
  }];
  uint32 zoom = 3;
}

message Bounds {
  option (buf.validate.message).cel_expression = "this.min_lon <= this.max_lon";
  option (buf.validate.message).cel_expression = "this.min_lat <= this.max_lat";

  float min_lon = 1;
  float min_lat = 2 [(buf.validate.field).float = {
    gte: -90
    lte: 90
  }];
  float max_lon = 3;
  float max_lat = 4 [(buf.validate.field).float = {
    gte: -90
    lte: 90
  }];
}

message StandardFeedbackDetail {
  enum Severity {
    success = 0;
    info = 1;
    error = 2;
  }

  message Entry {
    Severity severity = 1;
    optional string field = 2;
    string message = 3;
  }

  repeated Entry entries = 1;
}

// =============================================
// Pagination
// =============================================

message StandardPaginationState {
  message U64Cursors {
    uint64 snapshot = 1;
    uint64 page_first = 2;
    uint64 page_last = 3;
  }

  message TextCursors {
    string snapshot = 1;
    string page_first = 2;
    string page_last = 3;
  }

  // Cursor anchors for the stable snapshot and the current page boundaries.
  // - `u64`: id- and datetime-based cursors
  // - `text`: string cursors (e.g. display_name)
  oneof cursors {
    U64Cursors u64 = 1;
    TextCursors text = 2;
  }

  uint32 page_size = 3;
  uint32 current_page = 4;
  optional uint32 requested_page = 5;

  optional uint32 num_pages = 6;
  optional uint32 num_items = 7;
  uint32 max_known_page = 8;

  // Maximum id in the stable snapshot (used to exclude newly inserted rows).
  uint64 snapshot_max_id = 9;
  uint64 page_first_id = 10;
  uint64 page_last_id = 11;
}

// =============================================
// Configuration
// =============================================

// Centralized client configuration parameters
message WebConfig {
  // User-specific preferences
  message UserConfig {
    uint64 id = 1; // User ID
    string display_name = 2; // User display name
    string email = 3; // User email
    string avatar_url = 4; // User avatar URL
    optional LonLat home_point = 5; // User's home point
    bool activity_tracking = 6; // Enable usage analytics
    bool crash_reporting = 7; // Enable automatic error reports
    uint32 messages_count_unread = 8; // Unread messages count
    optional uint32 reports_count_moderator = 9; // Reports requiring moderator attention
    optional uint32 reports_count_administrator = 10; // Reports requiring admin attention
  }

  optional UserConfig user_config = 1; // User preferences override
}

// =============================================
// Routing & Navigation
// =============================================

// Turn-by-turn navigation instructions
message RoutingResult {
  // Start/end location metadata
  message Endpoint {
    string name = 1; // Location display name
    Bounds bounds = 2 [(buf.validate.field).required = true]; // Approximate endpoint area
    LonLat location = 3 [(buf.validate.field).required = true];
  }

  // Data provider attribution metadata
  message Attribution {
    string href = 1; // Provider URL
    string label = 2; // Link label
  }

  // Single navigation instruction step
  message Step {
    uint32 num_coords = 1; // Number of coordinates in the polyline (incl. overlapping ends)
    float distance = 2; // Meters
    float duration_seconds = 3; // Seconds
    uint32 icon_num = 4; // Icon code for this instruction
    string text = 5; // Human-readable instruction
  }

  // Elevation profile summary
  message Elevation {
    float ascend = 1; // Total meters climbed
    float descend = 2; // Total meters descended
  }

  optional Endpoint start = 1; // Route origin
  optional Endpoint end = 2; // Route destination
  Attribution attribution = 3 [(buf.validate.field).required = true]; // Data provider attribution
  repeated Step steps = 4; // Navigation steps
  uint32 line_quality = 5; // Quality of the polyline encoding
  string line = 6; // Encoded polyline for the route
  optional Elevation elevation = 7; // Terrain metrics
}

// =============================================
// UI Element Metadata
// =============================================

enum ElementType {
  node = 0;
  way = 1;
  relation = 2;
}

message ElementRef {
  ElementType type = 1 [(buf.validate.field).enum.defined_only = true];
  uint64 id = 2 [(buf.validate.field).uint64.gt = 0];
}

message ElementVersionRef {
  ElementType type = 1 [(buf.validate.field).enum.defined_only = true];
  uint64 id = 2 [(buf.validate.field).uint64.gt = 0];
  uint64 version = 3 [(buf.validate.field).uint64.gt = 0];
}

// Icon with tooltip for map elements
message ElementIcon {
  string icon = 1; // Icon URL
  string title = 2; // Accessible tooltip text
}

// Encoded user activity heatmap data
message UserActivityChart {
  string start_date = 1; // ISO date (YYYY-MM-DD) of the first cell (UTC)
  repeated uint32 values = 2; // Raw activity count per day, chronological
  bytes levels = 3; // Intensity levels per day (0-19) aligned with values
}
