syntax = "proto3";

import "buf/validate/validate.proto";

// =============================================
// Common
// =============================================

message IdResponse {
  uint64 id = 1;
}

message User {
  uint64 id = 1;
  string display_name = 2;
  string avatar_url = 3;
}

message LonLat {
  float lon = 1 [(buf.validate.field).float = {
    gte: -180
    lte: 180
  }];
  float lat = 2 [(buf.validate.field).float = {
    gte: -90
    lte: 90
  }];
}

message LonLatZoom {
  float lon = 1 [(buf.validate.field).float = {
    gte: -180
    lte: 180
  }];
  float lat = 2 [(buf.validate.field).float = {
    gte: -90
    lte: 90
  }];
  uint32 zoom = 3;
}

message Bounds {
  option (buf.validate.message).cel_expression = "this.min_lon <= this.max_lon";
  option (buf.validate.message).cel_expression = "this.min_lat <= this.max_lat";

  float min_lon = 1;
  float min_lat = 2 [(buf.validate.field).float = {
    gte: -90
    lte: 90
  }];
  float max_lon = 3;
  float max_lat = 4 [(buf.validate.field).float = {
    gte: -90
    lte: 90
  }];
}

message StandardFeedbackDetail {
  enum Severity {
    success = 0;
    info = 1;
    error = 2;
  }

  message Entry {
    Severity severity = 1;
    optional string field = 2;
    string message = 3;
  }

  repeated Entry entries = 1;
}

// =============================================
// Pagination
// =============================================

message StandardPaginationState {
  message U64Cursors {
    uint64 snapshot = 1;
    uint64 page_first = 2;
    uint64 page_last = 3;
  }

  message TextCursors {
    string snapshot = 1;
    string page_first = 2;
    string page_last = 3;
  }

  // Cursor anchors for the stable snapshot and the current page boundaries.
  // - `u64`: id- and datetime-based cursors
  // - `text`: string cursors (e.g. display_name)
  oneof cursors {
    U64Cursors u64 = 1;
    TextCursors text = 2;
  }

  uint32 page_size = 3;
  uint32 current_page = 4;
  optional uint32 requested_page = 5;

  optional uint32 num_pages = 6;
  optional uint32 num_items = 7;
  uint32 max_known_page = 8;

  // Maximum id in the stable snapshot (used to exclude newly inserted rows).
  uint64 snapshot_max_id = 9;
  uint64 page_first_id = 10;
  uint64 page_last_id = 11;
}

// =============================================
// Configuration
// =============================================

// Centralized client configuration parameters
message WebConfig {
  // User-specific preferences
  message UserConfig {
    uint64 id = 1; // User ID
    string display_name = 2; // User display name
    string avatar_url = 3; // User avatar URL
    optional LonLat home_point = 4; // User's home point
    bool activity_tracking = 5; // Enable usage analytics
    bool crash_reporting = 6; // Enable automatic error reports
    uint32 messages_count_unread = 7; // Unread messages count
    optional uint32 reports_count_moderator = 8; // Reports requiring moderator attention
    optional uint32 reports_count_administrator = 9; // Reports requiring admin attention
  }

  optional UserConfig user_config = 1; // User preferences override
}

// =============================================
// Authentication
// =============================================

// Password transmission container for different schema versions
message TransmitUserPassword {
  optional string legacy = 1; // Unencrypted password (deprecated)
  optional bytes v1 = 2; // Client-side PBKDF2 hash digest
}

// Passkey registration attestation from WebAuthn create()
message PasskeyRegistration {
  bytes client_data_json = 1;
  bytes attestation_object = 2;
  repeated string transports = 3;
}

// Passkey login assertion from WebAuthn get()
message PasskeyAssertion {
  bytes credential_id = 1;
  bytes client_data_json = 2;
  bytes authenticator_data = 3;
  bytes signature = 4;
}

// Passkey credential for WebAuthn allow/exclude lists
message PasskeyCredential {
  bytes credential_id = 1;
  repeated string transports = 2;
}

// Passkey challenge response for WebAuthn create()/get()
message PasskeyChallenge {
  bytes challenge = 1;
  repeated PasskeyCredential credentials = 2;
  uint64 user_id = 3;
  string user_display_name = 4;
  string user_email = 5;
}

// Login response for 2FA flow
message LoginResponse {
  optional bool passkey = 1;
  optional uint32 totp = 2;
  optional bool recovery = 3;
}

// =============================================
// Messages
// =============================================

// Messages list pagination payload
message MessagePage {
  message Summary {
    uint64 id = 1;
    optional User sender = 2;
    repeated User recipients = 3;
    uint32 recipients_count = 4;
    bool unread = 5;
    uint64 time = 6; // Timestamp in seconds (UTC)
    string subject = 7;
    string body_preview = 8;
  }

  repeated Summary messages = 1;
}

// Message read response
message MessageRead {
  bool was_unread = 1; // Whether this fetch transitioned from unread -> read
  User sender = 2; // Message author
  repeated User recipients = 3; // Message recipients
  bool is_recipient = 4; // Whether current user is a recipient
  uint64 time = 5; // Timestamp in seconds (UTC)
  string subject = 6; // Message subject
  string body_rich = 7; // Rich text HTML body
}

// =============================================
// Routing & Navigation
// =============================================

// Turn-by-turn navigation instructions
message RoutingResult {
  // Start/end location metadata
  message Endpoint {
    string name = 1; // Location display name
    Bounds bounds = 2 [(buf.validate.field).required = true]; // Approximate endpoint area
    LonLat location = 3 [(buf.validate.field).required = true];
  }

  // Data provider attribution metadata
  message Attribution {
    string href = 1; // Provider URL
    string label = 2; // Link label
  }

  // Single navigation instruction step
  message Step {
    uint32 num_coords = 1; // Number of coordinates in the polyline (incl. overlapping ends)
    float distance = 2; // Meters
    float time = 3; // Seconds
    uint32 icon_num = 4; // Icon code for this instruction
    string text = 5; // Human-readable instruction
  }

  // Elevation profile summary
  message Elevation {
    float ascend = 1; // Total meters climbed
    float descend = 2; // Total meters descended
  }

  optional Endpoint start = 1; // Route origin
  optional Endpoint end = 2; // Route destination
  Attribution attribution = 3 [(buf.validate.field).required = true]; // Data provider attribution
  repeated Step steps = 4; // Navigation steps
  uint32 line_quality = 5; // Quality of the polyline encoding
  string line = 6; // Encoded polyline for the route
  optional Elevation elevation = 7; // Terrain metrics
}

// =============================================
// UI Element Metadata
// =============================================

enum ElementType {
  node = 0;
  way = 1;
  relation = 2;
}

message ElementRef {
  ElementType type = 1 [(buf.validate.field).enum.defined_only = true];
  uint64 id = 2 [(buf.validate.field).uint64.gt = 0];
}

message ElementVersionRef {
  ElementType type = 1 [(buf.validate.field).enum.defined_only = true];
  uint64 id = 2 [(buf.validate.field).uint64.gt = 0];
  uint64 version = 3 [(buf.validate.field).uint64.gt = 0];
}

// Icon with tooltip for map elements
message ElementIcon {
  string icon = 1; // Icon URL
  string title = 2; // Accessible tooltip text
}

// Encoded user activity heatmap data
message UserActivityChart {
  string start_date = 1; // ISO date (YYYY-MM-DD) of the first cell (UTC)
  repeated uint32 values = 2; // Raw activity count per day, chronological
  bytes levels = 3; // Intensity levels per day (0-19) aligned with values
}
